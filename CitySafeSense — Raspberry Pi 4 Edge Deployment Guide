ğŸš€ CitySafeSense â€” Raspberry Pi 4 Edge Deployment Guide

This guide walks you through preparing a Raspberry Pi 4 to run the CitySafeSense Edge AI Inference Runtime, including:

OS setup

Installing dependencies

Installing the model + inference service

Secure MQTT configuration

Running as a systemd service or as a Docker container

Everything is optimized for Raspberry Pi 4 (ARM64 or ARMv7).

1. ğŸ”§ Raspberry Pi 4 â€” System Preparation
âœ”ï¸ Recommended OS

Use Raspberry Pi OS (64-bit):

Raspberry Pi OS Lite 64-bit (preferred)

Raspberry Pi OS Desktop 64-bit

âœ”ï¸ Update the system
sudo apt update && sudo apt full-upgrade -y
sudo reboot

âœ”ï¸ Essential packages
sudo apt install -y python3 python3-pip python3-venv git wget unzip mosquitto-clients

2. ğŸ” Install TFLite Runtime (optimized for Pi 4)

TensorFlow Lite full is too heavy; Raspberry Pi uses tflite-runtime.

Determine your Python version:
python3 --version

Install TFLite Runtime wheel

For Python 3.9+ on Raspberry Pi 4 (ARM64):

# Example wheel (replace with the latest ARM64 wheel matching your version):
pip3 install https://github.com/google-coral/pycoral/releases/download/release-frogfish/tflite_runtime-2.14.0-cp39-cp39-linux_aarch64.whl


If you're running ARMv7 (32-bit), install the ARMv7 wheel instead.

3. ğŸ“ Deploy CitySafeSense Files to Pi

On your local machine, copy the release bundle:

scp -r citysafesense-release-bundle/ pi@<YOUR_PI_IP>:/home/pi/citysafesense/


or clone your repo directly on the Pi:

cd ~
git clone https://github.com/<your-org>/citysafesense.git
cd citysafesense


Ensure the folder contains:

models/model_quant.tflite
infer_edge.py
client_mqtt.py
certs/
release-dist/  (optional for debugging)

4. âš™ï¸ Create Python Virtual Environment
cd ~/citysafesense
python3 -m venv venv
source venv/bin/activate

pip install --upgrade pip
pip install -r requirements.txt


If tflite_runtime was not inside requirements, install manually:

pip install tflite-runtime

5. ğŸ”§ Configure MQTT Secure Connection (Recommended)
Create directory:
mkdir -p ~/citysafesense/certs


Add files:

certs/ca.pem
certs/client.crt       (optional â€” if using mutual TLS)
certs/client.key       (optional)

Test connection:
mosquitto_sub --cafile certs/ca.pem \
  -h mqtt.example.local \
  -t "citysafesense/events/#" \
  -u device1 -P "<password>"

6. ğŸ¤– Running the Model â€” Manual Test
source venv/bin/activate
python infer_edge.py \
  --model models/model_quant.tflite \
  --mqtt mqtt.example.local \
  --tls-cert certs/ca.pem \
  --topic citysafesense/events \
  --device-id pi4-edge-001


If everything works, youâ€™ll see logs like:

[INFO] Window processed â€” anomaly_prob=0.87
[MQTT] Published event to citysafesense/events

7. ğŸ” Running as a Persistent systemd Service (recommended)

Create file:

sudo nano /etc/systemd/system/citysafesense.service


Paste:

[Unit]
Description=CitySafeSense Edge AI Inference (Raspberry Pi 4)
After=network-online.target

[Service]
User=pi
WorkingDirectory=/home/pi/citysafesense
Environment="PATH=/home/pi/citysafesense/venv/bin"
ExecStart=/home/pi/citysafesense/venv/bin/python infer_edge.py \
    --model models/model_quant.tflite \
    --mqtt mqtt.example.local \
    --tls-cert certs/ca.pem \
    --topic citysafesense/events \
    --device-id pi4-edge-001
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target


Run:

sudo systemctl daemon-reload
sudo systemctl enable citysafesense
sudo systemctl start citysafesense
sudo journalctl -u citysafesense -f

8. ğŸ³ Running with Docker (optional but excellent)
Install Docker:
curl -fsSL https://get.docker.com | sh
sudo usermod -aG docker pi


Logout & login.

Build or pull image

Using your published GHCR image:

docker pull ghcr.io/<OWNER>/citysafesense-demo:latest


If you need to build on the Pi:

docker build -f Dockerfile.prod -t citysafesense-edge:latest .

Run container
docker run -d \
  --name citysafesense \
  --restart unless-stopped \
  -v $(pwd)/models:/app/models:ro \
  -v $(pwd)/certs:/app/certs:ro \
  -e MQTT_HOST=mqtt.example.local \
  -e MQTT_TOPIC=citysafesense/events \
  -e DEVICE_ID=pi4-edge-001 \
  -p 8080:80 \
  ghcr.io/<OWNER>/citysafesense-demo:latest


View logs:

docker logs -f citysafesense

9. ğŸ“Š Validate Data Flow
Check MQTT messages arriving:
mosquitto_sub --cafile certs/ca.pem -h mqtt.example.local \
  -t "citysafesense/events" -v -u user -P pass

Common telemetry JSON:
{
  "device": "pi4-edge-001",
  "timestamp": 1715982012,
  "event": "forced_displacement",
  "probability": 0.92,
  "vector": [0.12, -1.09, 3.88]
}

10. âœ”ï¸ Performance Tips for Raspberry Pi 4
Enable 64-bit mode

Use Raspberry Pi OS 64-bit for fastest TFLite inference.

Disable CPU throttling during testing:
vcgencmd measure_temp
vcgencmd get_throttled

Use performance governor:
sudo apt install -y cpufrequtils
echo 'GOVERNOR="performance"' | sudo tee /etc/default/cpufrequtils
sudo systemctl restart cpufrequtils

Reduce SD card wear:

Use Docker bind mounts or tmpfs for logs.

11. ğŸ§ª Troubleshooting
âŒ TFLite says â€œunsupported opâ€

Your model uses ops not included in TF Lite Micro / TF Lite Runtime minimal build.
Solution: Enable â€œSELECT_TF_OPSâ€ or reduce model complexity.

âŒ MQTT TLS failure

Verify CA file matches brokerâ€™s CA:

openssl s_client -connect mqtt.example.local:8883 -CAfile certs/ca.pem

âŒ Low performance

Try:

int8 quantized model

fewer filters / layers

smaller window size

use Pi 4 overclocking (if safe)

12. ğŸ‰ Raspberry Pi 4 Deployment Complete

Your Pi now:

Runs quantized TFLite inference

Publishes anomaly events to MQTT securely

Starts automatically on boot via systemd or Docker

Can be mass-deployed using SD card images or fleet tools like Balena, Ansible, or Mender
